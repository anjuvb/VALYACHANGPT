import React, { useState, useEffect, useRef } from 'react';
import { SendHorizonal, Loader2 } from 'lucide-react'; // Using lucide-react for icons

// Main App component
export default function App() {
  // State to hold the list of chat messages. Each message is an object.
  const [messages, setMessages] = useState([]);
  // State to hold the current user input in the message box.
  const [input, setInput] = useState('');
  // State to track if the bot is currently generating a response.
  const [isLoading, setIsLoading] = useState(false);
  // Ref for the chat messages container to enable auto-scrolling to the bottom.
  const messagesEndRef = useRef(null);
  
  // Placeholder URL for the wise old man background image.
  // This public domain image is from Wikimedia Commons.
  const backgroundImage = 'https://upload.wikimedia.org/wikipedia/commons/e/e6/A_Wise_Old_Man.jpg';

  // useEffect hook to scroll to the bottom of the chat window whenever messages are updated.
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // Function to handle the form submission when the user sends a message.
  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userMessage = input;
    // Add the user's message to the chat history immediately.
    setMessages((prevMessages) => [...prevMessages, { text: userMessage, sender: 'user' }]);
    setInput('');
    setIsLoading(true);

    try {
      // Create a prompt for the Valyachan GPT.
      const prompt = `You are a wise, old man persona known as "Valyachan" from a Malayalam movie. Your job is to respond to user messages with short, funny, and iconic Malayalam movie dialogues. Do not break character. Do not provide translations or explanations. The response must be a single, witty Malayalam movie dialogue. Respond to the following user message: "${userMessage}".`;
      
      let chatHistory = [];
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });
      const payload = { contents: chatHistory };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.statusText}`);
      }

      const result = await response.json();
      const botResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Kshemikkanam, Valyachan ippo online-il illa.';

      // Add the bot's response to the chat history.
      setMessages((prevMessages) => [...prevMessages, { text: botResponseText, sender: 'bot' }]);

    } catch (error) {
      console.error('Failed to fetch from API:', error);
      // Handle the error by adding a default error message from the bot.
      setMessages((prevMessages) => [...prevMessages, { text: "Enthelum thettu patti, mone. Enikku ippo onnum parayanilla.", sender: 'bot' }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    // Main container with the background image and full screen dimensions.
    <div className="flex h-screen w-screen justify-center items-center p-4" 
         style={{ backgroundImage: `url(${backgroundImage})`, backgroundSize: 'cover', backgroundPosition: 'center' }}>
      
      {/* Semi-transparent chat container for the "more transparent" effect. */}
      <div className="w-full max-w-xl h-[80vh] flex flex-col bg-black bg-opacity-70 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden p-6 border border-gray-600">
        
        {/* Chat header */}
        <div className="flex items-center space-x-4 mb-4 pb-4 border-b border-gray-500">
          <div className="w-12 h-12 flex-shrink-0 bg-gray-400 rounded-full flex items-center justify-center font-bold text-2xl text-black">
            üë¥
          </div>
          <div className="text-white">
            <h1 className="text-xl font-bold">Valyachan GPT</h1>
            <p className="text-sm text-gray-400">‡¥®‡¥ø‡¥®‡¥ï‡µç‡¥ï‡µÜ‡¥®‡µç‡¥§‡¥æ ‡¥Æ‡µã‡¥®‡µá ‡¥Ö‡¥±‡¥ø‡¥Ø‡µá‡¥£‡µç‡¥ü‡¥§‡µç?</p>
          </div>
        </div>

        {/* Chat messages display area */}
        <div className="flex-1 overflow-y-auto space-y-4 pr-2">
          {messages.map((msg, index) => (
            <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`p-4 rounded-3xl max-w-[75%] ${msg.sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-white rounded-bl-none'}`}>
                {msg.text}
              </div>
            </div>
          ))}
          
          {/* Loading indicator for the bot's response */}
          {isLoading && (
            <div className="flex justify-start">
              <div className="p-4 rounded-3xl bg-gray-700 text-white rounded-bl-none">
                <Loader2 className="animate-spin" size={24} />
              </div>
            </div>
          )}

          {/* Ref for auto-scrolling */}
          <div ref={messagesEndRef} />
        </div>

        {/* Message input form */}
        <form onSubmit={handleSendMessage} className="mt-6 flex gap-3">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            className="flex-1 p-4 rounded-full bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
            placeholder="Valyacha, oru karyam chodikkatte..."
            disabled={isLoading}
          />
          <button
            type="submit"
            className="p-4 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed"
            disabled={isLoading}
          >
            <SendHorizonal size={24} />
          </button>
        </form>
      </div>
    </div>
  );
}

